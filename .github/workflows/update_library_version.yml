name: Update Notion Dependencies Database

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Podfile.lock'
      - '**.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved'
  
  workflow_dispatch:

jobs:
  update-notion:
    runs-on: macos-15
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œçŸ¥ç”¨

    - name: Detect changed dependency files
      id: detect-changes
      run: |
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        
        LIBRARY_TYPES=""
        if echo "$CHANGED_FILES" | grep -q "Podfile.lock"; then
          LIBRARY_TYPES="${LIBRARY_TYPES}CocoaPods,"
        fi
        if echo "$CHANGED_FILES" | grep -q "Package.resolved"; then
          LIBRARY_TYPES="${LIBRARY_TYPES}SPM,"
        fi
        
        # æœ«å°¾ã®ã‚«ãƒ³ãƒžã‚’é™¤åŽ»
        LIBRARY_TYPES=${LIBRARY_TYPES%,}
        
        echo "library-types=$LIBRARY_TYPES" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Detected changes in: $LIBRARY_TYPES"
    
    - name: Update Notion database
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        PROJECT_NAME: ${{ github.repository }}
        LIBRARY_TYPES: ${{ steps.detect-changes.outputs.library-types }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_RUN_ID: ${{ github.run_id }}
      run: |
        chmod +x Scripts/update_notion.sh
        ./Scripts/update_notion.sh
