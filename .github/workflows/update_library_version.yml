name: Update Notion Dependencies Database

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Podfile.lock'
      - '**/Package.resolved'
  
  workflow_dispatch:

jobs:
  update-notion:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Debug script content
      run: |
        echo "=== Script file info ==="
        ls -la Scripts/
        echo ""
        echo "=== Script line count ==="
        wc -l Scripts/update_notion.sh
        echo ""
        echo "=== Check for old patterns ==="
        grep -n "Processing.*(" Scripts/update_notion.sh && echo "❌ Old version detected!" || echo "✅ New version confirmed"
        echo ""
        echo "=== Check for multi_select ==="
        grep -n "multi_select" Scripts/update_notion.sh && echo "✅ Multi-select found" || echo "❌ Multi-select missing!"
        echo ""
        echo "=== Check for individual loop ==="
        grep -n "for manager in.*MANAGERS" Scripts/update_notion.sh && echo "❌ Individual loop found!" || echo "✅ No individual loop"
        echo ""
        echo "=== First 20 lines of script ==="
        head -20 Scripts/update_notion.sh

    - name: Update Notion database
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        PROJECT_NAME: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
      run: |
        chmod +x Scripts/update_notion.sh
        ./Scripts/update_notion.sh
